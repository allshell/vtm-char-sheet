<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VtM è§’è‰²å¡ç”Ÿæˆå™¨ v_0.0.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blood: '#8a0b0b',
                        darkbg: '#1a1a1a',
                        panel: '#2d2d2d'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .input-group label { display: block; font-size: 0.875rem; color: #a1a1a1; margin-bottom: 0.25rem; }
        .stat-input { 
            width: 100%; 
            background-color: #383838; 
            border: 1px solid #4a4a4a; 
            color: white; 
            padding: 0.5rem; 
            border-radius: 0.375rem; 
            transition: border-color 0.2s;
        }
        .stat-input:focus { outline: none; border-color: #8a0b0b; }
        .category-title { color: #cc3333; font-weight: bold; border-bottom: 2px solid #5c1818; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-upload-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blood text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wider">VtM è§’è‰²å½•å…¥å™¨</h1>
            <div class="flex space-x-2 bg-black/30 p-1 rounded">
                <button onclick="switchMode('V5')" id="btn-v5" class="px-4 py-1 rounded transition-colors bg-white text-blood font-bold">V5</button>
                <button onclick="switchMode('V20')" id="btn-v20" class="px-4 py-1 rounded transition-colors text-gray-300 hover:bg-white/10">V20</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow mb-20">
        
        <div class="bg-panel p-4 rounded-lg mb-6 shadow-md border-l-4 border-green-700 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-sm text-gray-300">
                <h3 class="font-bold text-white text-lg mb-1">Excel è‡ªåŠ¨å¡äº’é€š (V5 Only)</h3>
                <p>ä¸Šä¼  .xlsm äººç‰©å¡è‡ªåŠ¨å¡«è¡¨ï¼Œæˆ–ä¿®æ”¹åå¯¼å‡ºæ–°çš„ .xlsm æ–‡ä»¶ï¼ˆå®‰å…¨è€ƒè™‘æš‚ä¸å¤„ç† Excel å®ï¼Œå› æ­¤ä¸å­˜å–å®ç›¸å…³æ•°æ®ï¼ŒåŒ…æ‹¬ç”Ÿå‘½ã€æ„å¿—ã€é¥¥æ¸´ã€äººæ€§ï¼Œå¯¼å‡ºæ–‡ä»¶ä¹Ÿä¸åŒ…å«å®ç‰¹æ€§ï¼Œä»…ä½œä¸ºå­˜æ¡£ä½¿ç”¨ï¼‰ã€‚</p>
            </div>
            <div class="flex gap-3">
                <div class="file-upload-wrapper bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow cursor-pointer">
                    <span>ğŸ“‚ å¯¼å…¥ Excel</span>
                    <input type="file" id="excel-import" accept=".xlsx, .xlsm, .xls" onchange="handleExcelImport(this)">
                </div>
                <button onclick="handleExcelExport()" id="btn-export" class="bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow opacity-50 cursor-not-allowed" disabled>
                    ğŸ’¾ å¯¼å‡º Excel
                </button>
            </div>
        </div>

        <div class="bg-panel p-4 rounded-lg mb-6 shadow-md border-l-4 border-blood">
            <p class="text-sm text-gray-300">
                å½“å‰æ¨¡å¼: <span id="current-mode-display" class="font-bold text-white">V5</span><br>
                å¡«å†™ä¸‹æ–¹æ•°æ®ï¼Œç‚¹å‡»åº•éƒ¨æŒ‰é’®ç”ŸæˆæŒ‡ä»¤ã€‚å°†ç”Ÿæˆçš„æŒ‡ä»¤å¤åˆ¶å¹¶å‘é€ç»™æ­è½½äº† VtM æ’ä»¶çš„ SealDiceã€‚
            </p>
        </div>

        <form id="char-form" onsubmit="event.preventDefault();">
            <div id="section-core" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>

            <h2 class="category-title">å±æ€§ (Attributes)</h2>
            <div id="section-attrs" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>

            <h2 class="category-title" id="skills-title">æŠ€èƒ½ (Skills)</h2>
            <div id="section-skills" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>

            <div id="container-virtues" class="hidden">
                <h2 class="category-title">ç¾å¾· (Virtues)</h2>
                <div id="section-virtues" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
            </div>

            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-bold text-red-400">å¾‹èƒ½ä¸å…¶ä»– (Custom)</h2>
                <button onclick="addCustomField()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">+ æ·»åŠ é¡¹ç›®</button>
            </div>
            <div id="section-custom" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                </div>
        </form>
    </main>

    <footer class="fixed bottom-0 left-0 w-full bg-darkbg border-t border-gray-700 p-4 shadow-2xl z-50">
        <div class="container mx-auto flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="w-full md:w-3/4">
                <div class="relative">
                    <input type="text" id="output-cmd" readonly 
                        class="w-full bg-black border border-gray-600 text-green-400 font-mono p-3 rounded pr-24 focus:outline-none"
                        placeholder="ç‚¹å‡»å³ä¾§ç”ŸæˆæŒ‰é’®...">
                    <button onclick="copyCommand()" class="absolute right-1 top-1 bottom-1 bg-gray-800 hover:bg-gray-700 text-white px-3 rounded text-xs transition">
                        å¤åˆ¶æŒ‡ä»¤
                    </button>
                </div>
            </div>
            <button onclick="generateCommand()" class="w-full md:w-1/4 bg-blood hover:bg-red-800 text-white font-bold py-3 rounded shadow-lg transition transform active:scale-95">
                ç”Ÿæˆå½•å¡æŒ‡ä»¤
            </button>
        </div>
    </footer>

    <script>
        // --- V5 Excel æ˜ å°„é…ç½® ---
        // æ ¼å¼: "å±æ€§å": "å•å…ƒæ ¼åæ ‡"
        const V5_EXCEL_MAP = {
            // --- æ ¸å¿ƒ ---
            "HP": "C94",
            "æ„å¿—åŠ›": "C96",
            "äººæ€§": "C98",
            "é¥¥æ¸´": "H96",

            // --- å±æ€§ (Attributes) ---
            "åŠ›é‡": "C68", "æ•æ·": "C69", "ä½“è´¨": "C70",
            "é­…åŠ›": "F68", "æ“æ§": "F69", "æ²‰ç€": "F70",
            "æ™ºåŠ›": "I68", "æœºæ™º": "I69", "å†³å¿ƒ": "I70",

            // --- æŠ€èƒ½ (Skills) ---
            "è¿åŠ¨": "C82", "è‚‰æ": "C83", "æ‰‹è‰º": "C84", "é©¾é©¶": "C85", "æªæ¢°": "C86",
            "ç›—çªƒ": "C87", "ç™½åˆƒ": "C88", "æ½œè¡Œ": "C89", "ç”Ÿå­˜": "C90",
            
            "é©¯å…½": "F82", "ç¤¼ä»ª": "F83", "æ´æ‚‰": "F84", "å¨å“": "F85", "é¢†å¯¼": "F86", 
            "è¡¨æ¼”": "F87", "è¯´æœ": "F88", "è¡—å¤´": "F89", "æ¬ºç’": "F90",
            
            "å­¦æœ¯": "I82", "è§‰å¯Ÿ": "I83", "é‡‘è": "I84", "è°ƒæŸ¥": "I85", "åŒ»ç–—": "I86", 
            "ç¥ç§˜": "I87", "æ”¿æ²»": "I88", "ç§‘å­¦": "I89", "ç§‘æŠ€": "I90"
        };

        // --- V5 è‡ªå®šä¹‰é¡¹ç›®åæ ‡é…ç½® ---
        // ä¾æ¬¡å¯¹åº”è‡ªåŠ¨å¡ä¸­çš„5ä¸ªè‡ªå®šä¹‰è¡€å¾‹æ§½ä½ï¼š{ name: åç§°å•å…ƒæ ¼, val: ç­‰çº§å•å…ƒæ ¼ }
        const V5_CUSTOM_COORDS = [
            { name: "K14", val: "K16" },
            { name: "K21", val: "K23" },
            { name: "K28", val: "K30" },
            { name: "K35", val: "K37" },
            { name: "K42", val: "K44" }
        ];

        // --- æ•°æ®å®šä¹‰ ---
        const DATA = {
            V5: {
                core: ["HP", "HPMax", "æ„å¿—åŠ›", "æ„å¿—åŠ›Max", "äººæ€§", "é¥¥æ¸´"],
                attrs: {
                    "ç”Ÿç†": ["åŠ›é‡", "æ•æ·", "ä½“è´¨"],
                    "ç¤¾ä¼š": ["é­…åŠ›", "æ“æ§", "æ²‰ç€"],
                    "å¿ƒæ™º": ["æ™ºåŠ›", "æœºæ™º", "å†³å¿ƒ"]
                },
                skills: {
                    "ç”Ÿç†": ["è¿åŠ¨", "è‚‰æ", "é©¾é©¶", "æªæ¢°", "ç›—çªƒ", "ç™½åˆƒ", "æ½œè¡Œ", "ç”Ÿå­˜", "æ‰‹è‰º"],
                    "ç¤¾ä¼š": ["é©¯å…½", "ç¤¼ä»ª", "æ´æ‚‰", "å¨å“", "é¢†å¯¼", "è¡¨æ¼”", "è¯´æœ", "è¡—å¤´", "æ¬ºç’"],
                    "å¿ƒæ™º": ["å­¦æœ¯", "è§‰å¯Ÿ", "é‡‘è", "è°ƒæŸ¥", "åŒ»ç–—", "ç¥ç§˜", "æ”¿æ²»", "ç§‘å­¦", "ç§‘æŠ€"]
                }
            },
            V20: {
                core: ["è¡€æ± ", "è¡€æ± Max", "æ„å¿—åŠ›", "æ„å¿—åŠ›Max", "äººæ€§/å¿ƒè·¯ç­‰çº§"],
                attrs: {
                    "ç”Ÿç†": ["åŠ›é‡", "æ•æ·", "è€åŠ›"],
                    "ç¤¾ä¼š": ["é­…åŠ›", "æ“æ§", "å¤–è²Œ"],
                    "å¿ƒæ™º": ["æ„ŸçŸ¥", "æ™ºåŠ›", "æœºæ™º"]
                },
                abilities: { 
                    "å¤©èµ‹": ["è­¦è§‰", "è¿åŠ¨", "æ ¼æ–—", "ç†è§£", "è¶…æ„Ÿ", "è¡¨è¾¾", "èƒè¿«", "é¢†å¯¼", "é»‘è¡—", "æ©é¥°"],
                    "æŠ€èƒ½": ["é©¯å…½", "æ‰‹è‰º", "é©¾é©¶", "ç¤¼ä»ª", "æªæ¢°", "ç™½åˆƒ", "è¡¨æ¼”", "æ½œè¡Œ", "ç”Ÿå­˜", "ç›—çªƒ"],
                    "çŸ¥è¯†": ["å­¦æœ¯", "ç”µè„‘", "é‡‘è", "è°ƒæŸ¥", "æ³•å¾‹", "åŒ»å­¦", "ç¥ç§˜", "æ”¿æ²»", "ç§‘å­¦", "ç§‘æŠ€"]
                },
                virtues: ["è‰¯çŸ¥/åšä¿¡", "è‡ªæ§/æœ¬èƒ½", "å‹‡æ°”"]
            }
        };

        let currentMode = 'V5';
        let customFieldCount = 0;
        let globalWorkbook = null; // å­˜å‚¨å¯¼å…¥çš„ Excel å¯¹è±¡ä»¥ä¾¿å¯¼å‡º

        // --- åˆå§‹åŒ–ä¸æ¸²æŸ“ ---

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('current-mode-display').innerText = mode;
            
            const btnV5 = document.getElementById('btn-v5');
            const btnV20 = document.getElementById('btn-v20');
            if (mode === 'V5') {
                btnV5.className = "px-4 py-1 rounded transition-colors bg-white text-blood font-bold shadow";
                btnV20.className = "px-4 py-1 rounded transition-colors text-gray-300 hover:bg-white/10";
            } else {
                btnV20.className = "px-4 py-1 rounded transition-colors bg-white text-blood font-bold shadow";
                btnV5.className = "px-4 py-1 rounded transition-colors text-gray-300 hover:bg-white/10";
            }
            
            // Excel åŠŸèƒ½ç›®å‰ä»…é€‚é… V5
            const importInput = document.getElementById('excel-import');
            if (mode === 'V20') {
                importInput.disabled = true;
                importInput.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
                importInput.parentElement.title = "Excel åŠŸèƒ½ç›®å‰ä»…é€‚é… V5";
            } else {
                importInput.disabled = false;
                importInput.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
                importInput.parentElement.title = "";
            }

            renderForm();
        }

        function createInput(key, label) {
            return `
                <div class="input-group">
                    <label>${label || key}</label>
                    <input type="number" data-key="${key}" class="stat-input" placeholder="0" min="0" max="10">
                </div>
            `;
        }

        function renderSection(containerId, dataObj, isGrouped = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (isGrouped) {
                for (const [groupName, items] of Object.entries(dataObj)) {
                    const col = document.createElement('div');
                    col.className = 'bg-panel p-4 rounded border border-gray-700';
                    let html = `<h3 class="text-gray-400 font-bold mb-3 text-center border-b border-gray-600 pb-1">${groupName}</h3><div class="space-y-3">`;
                    items.forEach(key => {
                        html += createInput(key);
                    });
                    html += '</div>';
                    col.innerHTML = html;
                    container.appendChild(col);
                }
            } else {
                dataObj.forEach(key => {
                    const div = document.createElement('div');
                    div.innerHTML = createInput(key);
                    container.appendChild(div);
                });
            }
        }

        function renderForm() {
            const data = DATA[currentMode];
            const coreContainer = document.getElementById('section-core');
            coreContainer.innerHTML = '';
            data.core.forEach(key => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = createInput(key);
                coreContainer.appendChild(wrapper);
            });
            renderSection('section-attrs', data.attrs, true);
            const skillTitle = document.getElementById('skills-title');
            skillTitle.innerText = currentMode === 'V5' ? 'æŠ€èƒ½ (Skills)' : 'èƒ½åŠ› (Abilities)';
            renderSection('section-skills', currentMode === 'V5' ? data.skills : data.abilities, true);
            const virtueContainer = document.getElementById('container-virtues');
            if (currentMode === 'V20') {
                virtueContainer.classList.remove('hidden');
                renderSection('section-virtues', data.virtues, false);
            } else {
                virtueContainer.classList.add('hidden');
            }
            document.getElementById('output-cmd').value = '';
        }

        // --- Excel å¤„ç†é€»è¾‘ ---

function handleExcelImport(input) {
            if (currentMode !== 'V5') {
                alert("Excel å¯¼å…¥åŠŸèƒ½ç›®å‰ä»…æ”¯æŒ V5 æ¨¡å¼");
                return;
            }
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                try {
                    const workbook = XLSX.read(data, { type: 'array' });
                    globalWorkbook = workbook; 

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // 1. è¯»å–æ ‡å‡†å±æ€§
                    for (const [key, cellRef] of Object.entries(V5_EXCEL_MAP)) {
                        const cell = worksheet[cellRef];
                        if (cell && cell.v !== undefined) {
                            const inputEl = document.querySelector(`input[data-key="${key}"]`);
                            if (inputEl) {
                                let val = parseInt(cell.v);
                                if (!isNaN(val)) {
                                    inputEl.value = val;
                                }
                            }
                        }
                    }

                    // 2. è¯»å–è‡ªå®šä¹‰é¡¹ç›® (æ–°å¢éƒ¨åˆ†)
                    // å…ˆæ¸…ç©ºç•Œé¢ä¸Šç°æœ‰çš„è‡ªå®šä¹‰æ¡†ï¼Œé˜²æ­¢é‡å¤å åŠ 
                    document.getElementById('section-custom').innerHTML = '';
                    customFieldCount = 0; 

                    V5_CUSTOM_COORDS.forEach(coord => {
                        const nameCell = worksheet[coord.name];
                        const valCell = worksheet[coord.val];

                        // å¦‚æœ Excel è¯¥ä½ç½®æœ‰å¡«å†™åç§°ï¼Œåˆ™åœ¨ç½‘é¡µä¸Šåˆ›å»ºä¸€ä¸ªå¯¹åº”è¾“å…¥æ¡†å¹¶å¡«å€¼
                        if (nameCell && nameCell.v) {
                            addCustomField(); // è‡ªåŠ¨ç‚¹å‡»â€œæ·»åŠ é¡¹ç›®â€
                            
                            // è·å–åˆšåˆšåˆ›å»ºçš„é‚£ä¸ªè¾“å…¥æ¡†è¡Œ (ID æ˜¯ custom-1, custom-2...)
                            const currentId = `custom-${customFieldCount}`;
                            const div = document.getElementById(currentId);
                            
                            if (div) {
                                const nameInput = div.querySelector('.custom-name');
                                const valInput = div.querySelector('.custom-val');
                                
                                nameInput.value = nameCell.v; // å¡«åç§°
                                if (valCell && valCell.v !== undefined) {
                                    valInput.value = parseInt(valCell.v) || 0; // å¡«ç­‰çº§
                                }
                            }
                        }
                    });

                    // å¯ç”¨å¯¼å‡ºæŒ‰é’®
                    const btnExport = document.getElementById('btn-export');
                    btnExport.disabled = false;
                    btnExport.classList.remove('opacity-50', 'cursor-not-allowed');
                    alert("å¯¼å…¥æˆåŠŸï¼æ ‡å‡†å±æ€§ä¸è‡ªå®šä¹‰é¡¹ç›®å·²åŠ è½½ã€‚");

                } catch (err) {
                    console.error(err);
                    alert("è¯»å– Excel å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
                }
            };
            reader.readAsArrayBuffer(file);
        }

function handleExcelExport() {
            if (!globalWorkbook) {
                alert("è¯·å…ˆå¯¼å…¥ä¸€ä¸ª Excel æ¨¡æ¿æ–‡ä»¶ï¼Œç³»ç»Ÿå°†åœ¨è¯¥æ–‡ä»¶åŸºç¡€ä¸Šä¿®æ”¹å¹¶å¯¼å‡ºã€‚");
                return;
            }
            if (currentMode !== 'V5') return;

            try {
                const firstSheetName = globalWorkbook.SheetNames[0];
                const worksheet = globalWorkbook.Sheets[firstSheetName];

                // 1. å†™å…¥æ ‡å‡†å±æ€§
                const inputs = document.querySelectorAll('#char-form input[data-key]');
                inputs.forEach(input => {
                    const key = input.getAttribute('data-key');
                    const val = parseInt(input.value);
                    const cellRef = V5_EXCEL_MAP[key];

                    if (cellRef && !isNaN(val)) {
                        if (!worksheet[cellRef]) worksheet[cellRef] = { t: 'n' };
                        worksheet[cellRef].v = val;
                        worksheet[cellRef].t = 'n';
                    }
                });

                // 2. å†™å…¥è‡ªå®šä¹‰é¡¹ç›® (æ–°å¢éƒ¨åˆ†)
                const customDivs = document.getElementById('section-custom').children;
                
                // éå† Excel ä¸­é¢„ç•™çš„5ä¸ªæ§½ä½
                V5_CUSTOM_COORDS.forEach((coord, index) => {
                    // å°è¯•è·å–ç½‘é¡µä¸Šå¯¹åº”çš„ç¬¬ index ä¸ªè‡ªå®šä¹‰é¡¹
                    const div = customDivs[index];
                    
                    if (div) {
                        // å¦‚æœç½‘é¡µä¸Šæœ‰è¿™ä¸€é¡¹ï¼Œåˆ™å†™å…¥ Excel
                        const nameInput = div.querySelector('.custom-name');
                        const valInput = div.querySelector('.custom-val');
                        const nameVal = nameInput.value.trim();
                        const valVal = parseInt(valInput.value);

                        if (nameVal) {
                            // å†™å…¥åç§°
                            if (!worksheet[coord.name]) worksheet[coord.name] = { t: 's' };
                            worksheet[coord.name].v = nameVal;
                            worksheet[coord.name].t = 's'; // ç±»å‹ï¼šå­—ç¬¦ä¸²

                            // å†™å…¥ç­‰çº§
                            if (!worksheet[coord.val]) worksheet[coord.val] = { t: 'n' };
                            worksheet[coord.val].v = !isNaN(valVal) ? valVal : 0;
                            worksheet[coord.val].t = 'n'; // ç±»å‹ï¼šæ•°å­—
                        } else {
                            // æœ‰æ¡†ä½†æ²¡åå­—ï¼Œè§†ä¸ºç©ºï¼Œæ“¦é™¤ Excel è¯¥ä½ç½®
                            if (worksheet[coord.name]) worksheet[coord.name].v = "";
                            if (worksheet[coord.val]) worksheet[coord.val].v = 0;
                        }
                    } else {
                        // å¦‚æœç½‘é¡µä¸Šæ²¡æœ‰è¿™ä¸€é¡¹ï¼ˆæ¯”å¦‚ä½ åªå¡«äº†2ä¸ªï¼ŒExcelæœ‰5ä¸ªç©ºä½ï¼‰ï¼Œåˆ™æ“¦é™¤ Excel ä¸­å¤šä½™çš„æ•°æ®
                        // è¿™æ ·å¯ä»¥ç¡®ä¿ Excel æ–‡ä»¶ä¸ä¼šæ®‹ç•™ä¸Šæ¬¡çš„æ•°æ®
                        if (worksheet[coord.name]) worksheet[coord.name].v = "";
                        if (worksheet[coord.val]) worksheet[coord.val].v = 0;
                    }
                });

                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(globalWorkbook, "V5_Character_Updated.xlsm");

            } catch (err) {
                console.error(err);
                alert("å¯¼å‡ºå¤±è´¥ï¼š" + err.message);
            }
        }

        // --- è‡ªå®šä¹‰å­—æ®µé€»è¾‘ ---

        function addCustomField() {
            customFieldCount++;
            const container = document.getElementById('section-custom');
            const div = document.createElement('div');
            div.className = "flex space-x-2 items-end bg-panel p-2 rounded border border-gray-600";
            div.id = `custom-${customFieldCount}`;
            div.innerHTML = `
                <div class="flex-grow">
                    <label class="text-xs text-gray-400">é¡¹ç›®åç§°</label>
                    <input type="text" class="custom-name w-full bg-black/50 text-white border border-gray-600 rounded px-2 py-1 text-sm focus:border-red-500 outline-none" placeholder="åç§°">
                </div>
                <div class="w-16">
                    <label class="text-xs text-gray-400">ç­‰çº§</label>
                    <input type="number" class="custom-val w-full bg-black/50 text-white border border-gray-600 rounded px-2 py-1 text-sm focus:border-red-500 outline-none" placeholder="0">
                </div>
                <button onclick="removeCustomField('custom-${customFieldCount}')" class="text-red-500 hover:text-red-300 font-bold px-2 py-1">Ã—</button>
            `;
            container.appendChild(div);
        }

        function removeCustomField(id) {
            document.getElementById(id).remove();
        }

        // --- ç”ŸæˆæŒ‡ä»¤é€»è¾‘ ---

        function generateCommand() {
            let cmdParts = [];
            const inputs = document.querySelectorAll('#char-form input[data-key]');
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if (!isNaN(val) && val !== 0) {
                    const key = input.getAttribute('data-key');
                    cmdParts.push(`${key}=${val}`);
                }
            });

            const customDivs = document.getElementById('section-custom').children;
            for (let div of customDivs) {
                const nameInput = div.querySelector('.custom-name');
                const valInput = div.querySelector('.custom-val');
                if (nameInput && valInput) {
                    const name = nameInput.value.trim();
                    const val = parseInt(valInput.value);
                    if (name && !isNaN(val)) {
                        cmdParts.push(`${name}=${val}`);
                    }
                }
            }

            if (cmdParts.length === 0) {
                alert("æœªå¡«å†™ä»»ä½•æœ‰æ•ˆæ•°æ® (0å€¼ä¼šè‡ªåŠ¨å¿½ç•¥)");
                return;
            }

            const finalCmd = `.vst ${cmdParts.join(' ')}`;
            const outputEl = document.getElementById('output-cmd');
            outputEl.value = finalCmd;
            outputEl.classList.add('bg-green-900');
            setTimeout(() => outputEl.classList.remove('bg-green-900'), 200);
        }

        function copyCommand() {
            const copyText = document.getElementById("output-cmd");
            if (!copyText.value) return;
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => {
                const btn = document.querySelector('button[onclick="copyCommand()"]');
                const originalText = btn.innerText;
                btn.innerText = "å·²å¤åˆ¶!";
                setTimeout(() => btn.innerText = originalText, 1500);
            });
        }

        window.onload = function() {
            renderForm();
        }
    </script>
</body>
</html>

